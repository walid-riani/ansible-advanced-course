---
# File: playbooks/bootstrap_passwordless_sudo.yml
# Purpose: Enable passwordless sudo for a given local user (default: walid)
# Target:   local (ansible_connection=local in inventory)
#
# Usage (eenmalig m√©t wachtwoordprompt):
#   ansible-playbook playbooks/bootstrap_passwordless_sudo.yml --ask-become-pass
#
# Daarna kun je plays met 'become: true' zonder --ask-become-pass draaien.

- name: Bootstrap | passwordless sudo voor lokale admin user
  hosts: local
  become: true
  gather_facts: true

  vars:
    target_user: "walid"
    # Standaard sudo-groep per OS-familie; override in group_vars/ of via -e
    sudo_group_map:
      RedHat: "wheel"
      Debian: "sudo"

  pre_tasks:
    - name: Assert ondersteunde OS-families
      ansible.builtin.assert:
        that:
          - ansible_os_family in ["RedHat", "Debian"]
        fail_msg: "Alleen RedHat/Alma/RHEL en Debian/Ubuntu zijn ondersteund."
      tags: [always]

    - name: Bepaal sudo-groep voor dit OS
      ansible.builtin.set_fact:
        sudo_group: "{{ sudo_group_map[ansible_os_family] | default('wheel') }}"
      tags: [always]

  tasks:
    - name: Zorg dat de user bestaat en in de juiste sudo-groep zit
      ansible.builtin.user:
        name: "{{ target_user }}"
        groups: "{{ sudo_group }}"
        append: true
        state: present
      tags: [user, sudo]

    - name: Maak sudoers-snippet voor passwordless sudo ({{ target_user }})
      ansible.builtin.copy:
        dest: "/etc/sudoers.d/{{ target_user }}"
        mode: "0440"
        owner: root
        group: root
        # visudo validatie voorkomt syntaxfouten in sudoers
        validate: "visudo -cf %s"
        content: |
          {{ target_user }} ALL=(ALL) NOPASSWD: ALL
      tags: [sudo, hardening]

    - name: (Optioneel) verwijder eventuele oude requiretty regel (RHEL-achtige)
      ansible.builtin.lineinfile:
        path: /etc/sudoers
        regexp: '^[#\s]*Defaults\s+requiretty'
        state: absent
        validate: "visudo -cf %s"
      when: ansible_os_family == "RedHat"
      tags: [sudo, hardening]

    - name: Toon samenvatting
      ansible.builtin.debug:
        msg:
          - "Passwordless sudo geactiveerd voor '{{ target_user }}'."
          - "Sudo-groep: {{ sudo_group }} ({{ ansible_os_family }})"
      tags: [summary]